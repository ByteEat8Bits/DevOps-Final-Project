name: Fetch and Update Stock Data

on:
  schedule:
    - cron: '0 10 * * *'  # æ¯å¤© UTC 0:00 åŸ·è¡Œ
  workflow_dispatch:      # æ‰‹å‹•è§¸ç™¼

jobs:
  # Job 1: æŠ“å–æ•¸æ“šä¸¦ç”¢ç”Ÿ Artifact
  fetch-data:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        
      - name: Notify checkout success
        run: echo "âœ… Repository checked out successfully."

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'  # ä½¿ç”¨ Python 3.x ç‰ˆæœ¬
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 1: åŸ·è¡Œè³‡æ–™æŠ“å–ç¨‹å¼
      - name: Run data fetch script
        run: |
          echo "ğŸš€ Starting data fetch script..."
          python fetch_data.py  # å‡è¨­é€™å€‹è…³æœ¬æœƒç”Ÿæˆ stock_data.csv æª”æ¡ˆ
          echo "âœ… Data fetch script executed successfully."

      # Step 1.5: å°‡è¼¸å‡ºæª”æ¡ˆå­˜ç‚º Artifact
      - name: Upload stock data as artifact
        uses: actions/upload-artifact@v3
        with:
          name: stock_data_artifact
          path: stock_data.csv  # æ›¿æ›ç‚ºä½ çš„å¯¦éš›æª”æ¡ˆåç¨±

  # Job 2: æ¨é€åˆ° data-archive åˆ†æ”¯
  push:
    runs-on: ubuntu-latest
    needs: fetch-data  # ä¾è³´ fetch-data å·¥ä½œï¼Œç¢ºä¿åªæœ‰åœ¨æŠ“å–æ•¸æ“šæˆåŠŸæ™‚æ‰åŸ·è¡Œ

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Download stock data artifact
        uses: actions/download-artifact@v3
        with:
          name: stock_data_artifact

      - name: Commit and push data to branch
        run: |
          echo "ğŸš€ Committing and pushing changes to branch..."
          git fetch origin data-archive:data-archive
          git checkout data-archive
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add stock_data.csv  # æ·»åŠ æ–‡ä»¶ä¸¦æäº¤
          git commit -m "Updated stock_data.csv from workflow"
          git push origin HEAD:data-archive  # å°‡è®Šæ›´æ¨é€åˆ° data-archiveåˆ†æ”¯ â—ä¹‹å¾Œå¦‚æœä¸ç”¨å»ºç«‹å–®ç¨åˆ†æ”¯æ”¾æª”æ¡ˆï¼Œéœ€è¦æ›´æ”¹
          echo "âœ… Changes pushed to repository successfully."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
