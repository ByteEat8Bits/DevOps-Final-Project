name: Fetch and Update Stock Data

on:
  schedule:
    - cron: '0 10 * * *'  # æ¯å¤© UTC 0:00 åŸ·è¡Œ
  workflow_dispatch:      # æ‰‹å‹•è§¸ç™¼

jobs:
  # Job 1: æŠ“å–æ•¸æ“šä¸¦ç”¢ç”Ÿ Artifact
  fetchData_and_cleanData:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        
      - name: Notify checkout success
        run: echo "âœ… Repository checked out successfully."

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'  # ä½¿ç”¨ Python 3.x ç‰ˆæœ¬
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 1: åŸ·è¡Œè³‡æ–™æŠ“å–ç¨‹å¼
      - name: Run data fetch script
        run: |
          echo "ğŸš€ Starting data fetch script..."
          python fetch_data.py  # é€™å€‹pythonæª”æœƒç”Ÿæˆ stock_data.csv æª”æ¡ˆ
          echo "âœ… Data fetch script executed successfully."

      # Step 2: åŸ·è¡Œ data_clean.py ç¨‹å¼è™•ç†æŠ“å–åˆ°çš„æ•¸æ“š
      - name: Run data clean script
        run: |
          echo "ğŸš€ Starting data clean script..."
          python data_clean.py  # data_clean.py æœƒè™•ç† stock_data.csv ä¸¦è¼¸å‡ºå¤šå€‹è‚¡ç¥¨çš„csv
          echo "âœ… Data clean script executed successfully."

      # Step 3: ä¸Šå‚³æ‰€æœ‰ CSV æª”æ¡ˆä½œç‚º Artifact
      - name: Upload stock data as artifact
        uses: actions/upload-artifact@v3
        with:
          name: data_artifact
          path: "*.csv"  # ä½¿ç”¨é€šé…ç¬¦å°‡æ‰€æœ‰ CSV æª”æ¡ˆä¸Šå‚³

  # Job 2: æ¨é€åˆ° gh-pagese åˆ†æ”¯
  push:
    runs-on: ubuntu-latest
    needs: fetchData_and_cleanData  # ä¾è³´ç¬¬ä¸€å€‹å·¥ä½œï¼Œç¢ºä¿åªæœ‰åœ¨æŠ“å–å’Œæ¸…ç†æˆåŠŸæ™‚æ‰åŸ·è¡Œ

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Switch to gh-pages branch  # å°‡è®Šæ›´æ¨é€åˆ° gh-pages åˆ†æ”¯ â—(ä¹‹å¾Œå¦‚æœä¸ç”¨å–®ç¨åˆ†æ”¯æ”¾æª”æ¡ˆï¼Œéœ€æ›´æ”¹)
        run: |
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages
          
      - name: Download stock data artifact
        uses: actions/download-artifact@v3
        with:
          name: data_artifact
      
      # æ’é™¤ stock_data.csvï¼Œä¸¦åªæ¨é€å…¶ä»– CSV æª”æ¡ˆ
      - name: Commit and push data to branch
        run: |
          echo "ğŸš€ Committing and pushing changes to branch..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # å‰µå»ºè³‡æ–™å¤¾ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p data  # 'data' è³‡æ–™å¤¾æœƒè¢«å‰µå»ºï¼Œå¦‚æœå·²ç¶“å­˜åœ¨å‰‡ä¸æœƒåšä»»ä½•äº‹

          # æ’é™¤ stock_data.csvï¼Œä¸¦å°‡å…¶ä»– CSV æª”æ¡ˆç§»å‹•åˆ° 'data' è³‡æ–™å¤¾
          for file in $(find . -name "*.csv" ! -name "stock_data.csv"); do
            mv "$file" data/  # ç§»å‹•æª”æ¡ˆåˆ° data è³‡æ–™å¤¾
            git add "data/$file"  # æ·»åŠ è³‡æ–™å¤¾å…§çš„æª”æ¡ˆåˆ° Git
          done

          git commit -m "Updated CSV files from workflow"
          git push origin HEAD  
          echo "âœ… Changes pushed to repository successfully."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
