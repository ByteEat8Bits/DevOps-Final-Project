name: Fetch and Update Stock Data

on:
  schedule:
    - cron: '0 10 * * *'  # 每天 UTC 0:00 執行
  workflow_dispatch:      # 手動觸發

jobs:
  # Job 1: 抓取數據並產生 Artifact
  fetchData_and_cleanData:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        
      - name: Notify checkout success
        run: echo "✅ Repository checked out successfully."

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'  # 使用 Python 3.x 版本
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 1: 執行資料抓取程式
      - name: Run data fetch script
        run: |
          echo "🚀 Starting data fetch script..."
          python fetch_data.py  # 這個python檔會生成 stock_data.csv 檔案
          echo "✅ Data fetch script executed successfully."

      # Step 2: 執行 data_clean.py 程式處理抓取到的數據
      - name: Run data clean script
        run: |
          echo "🚀 Starting data clean script..."
          python data_clean.py  # data_clean.py 會處理 stock_data.csv 並輸出多個股票的csv
          echo "✅ Data clean script executed successfully."

      # Step 3: 上傳所有 CSV 檔案作為 Artifact
      - name: Upload stock data as artifact
        uses: actions/upload-artifact@v3
        with:
          name: data_artifact
          path: "*.csv"  # 使用通配符將所有 CSV 檔案上傳

  # Job 2: 推送到 gh-pagese 分支
  push:
    runs-on: ubuntu-latest
    needs: fetchData_and_cleanData  # 依賴第一個工作，確保只有在抓取和清理成功時才執行

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Switch to gh-pages branch  # 將變更推送到 gh-pages 分支 ❗(之後如果不用單獨分支放檔案，需更改)
        run: |
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages
          
      - name: Download stock data artifact
        uses: actions/download-artifact@v3
        with:
          name: data_artifact
      
      # 排除 stock_data.csv，並只推送其他 CSV 檔案
      - name: Commit and push data to branch
        run: |
          echo "🚀 Committing and pushing changes to branch..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 創建資料夾（如果不存在）
          mkdir -p data  # 'data' 資料夾會被創建，如果已經存在則不會做任何事

          # 排除 stock_data.csv，並將其他 CSV 檔案移動到 'data' 資料夾
          for file in $(find . -name "*.csv" ! -name "stock_data.csv"); do
            mv "$file" data/  # 移動檔案到 data 資料夾
            git add "data/$file"  # 添加資料夾內的檔案到 Git
          done

          git commit -m "Updated CSV files from workflow"
          git push origin HEAD  
          echo "✅ Changes pushed to repository successfully."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
